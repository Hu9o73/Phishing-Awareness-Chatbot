# Database Schema Overview

This document summarizes the Postgres layout that the project expects when connecting to Supabase. All tables live under the `phishing_awareness_chatbot` schema configured in the backend client and are accessed through Supabase's PostgREST API.

## Platform

- **Provider:** Supabase (managed Postgres).
- **Schema:** `phishing_awareness_chatbot` (set on every client connection).
- **Access Pattern:** The backend relies on Supabase table RPCs via `supabase-py` for all CRUD operations; there are no ORM models or migrations in the repository.

## Tables

### `organizations`

| Column        | Type        | Notes                                                                    |
|---------------|-------------|--------------------------------------------------------------------------|
| `id`          | UUID        | Primary key generated by Supabase.                                       |
| `name`        | text        | Organization display name.                                               |
| `description` | text        | Optional longer description.                                             |
| `updated_at`  | timestamptz | Managed by Supabase triggers, at creation. To update manually afterwards.|
| `created_at`  | timestamptz | Managed by Supabase triggers (default `now()`).                          |

**Usage notes**

- When deleting an organization manually, ensure to cascade to dependent rows. No cascade setup in supabase, to keep track in our code.

### `users`

| Column            | Type            | Notes                                                                       |
|-------------------|-----------------|-----------------------------------------------------------------------------|
| `id`              | UUID            | Primary key generated by Supabase.                                          |
| `email`           | text            | Unique email address used for login. Conflicts are checked before insertion.|
| `password`        | text            | Hash of the user's password.                                                |
| `first_name`      | text            | User profile data.                                                          |
| `last_name`       | text            | User profile data.                                                          |
| `role`            | text            | Enum constrained to `MEMBER`, `ORG_ADMIN`, `ADMIN`.                         |
| `credits`         | integer         | Remaining usage credits for the user (defaults to 0, handled at creation).  |
| `organization_id` | UUID (nullable) | Must be an actual organization id, no FK defined in supbase, manual track.  |
| `updated_at`      | timestamptz     | Managed by Supabase triggers, at creation. To update manually afterwards.   |
| `created_at`      | timestamptz     | Managed by Supabase triggers (default `now()`).                             |

**Usage notes**

- Both admin and organization-admin flows create users by hashing the password before inserting the record and, when applicable, attaching the orgadmin's organization id.
- Login validates credentials by fetching the stored hash and comparing it with the submitted password's hash. No plain password shall ever be stored.
- User queries frequently join on `organization_id` to scope results or enforce ownership (e.g., listing members within an organization, deleting organization-scoped users).

### `org_members`

| Column            | Type        | Notes                                                                    |
|-------------------|-------------|--------------------------------------------------------------------------|
| `id`              | UUID        | Primary key generated by Supabase.                                       |
| `organization_id` | UUID        | Must refer to an `organizations.id`.                                     |
| `first_name`      | text        | Member profile data.                                                     |
| `last_name`       | text        | Member profile data.                                                     |
| `email`           | text        | Contact email for the member (=employee).                                |
| `updated_at`      | timestamptz | Managed by Supabase triggers, at creation. To update manually afterwards.|
| `created_at`      | timestamptz | Managed by Supabase triggers (default `now()`).                          |

**Usage notes**

- Org Members aren't user accounts, they're used to track employee's performances in the challenges users can send them.
- Organization administrators CRUD members within their organization by filtering on `organization_id` to enforce tenant scoping.
- Admin-level organization deletions also remove associated members prior to deleting the organization itself.

## Relationships Summary

- `organizations` is the parent entity. Both `users.organization_id` and `org_members.organization_id` reference it to express tenancy boundaries.
- Role-based logic depends on the `users.role` column; only users with `ORG_ADMIN` or `ADMIN` roles can manage organization-level records. (Theirs (`ORG_ADMINS`), or any (`ADMINS`))

## Adding New Tables

If you introduce new tables, keep the following in mind:

1. Update Supabase (SQL migrations or dashboard) to create the table and any required policies.
2. Add corresponding Pydantic models and interaction logic under `Application/pac-back/src/{your_service}/app/models` and `.../database/interactors` so that the backend can read/write the new data.
3. Extend this document with the new table and relationships to keep the overview current.
